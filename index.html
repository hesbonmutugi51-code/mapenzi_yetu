<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapenzi Yetu üíñ - Tugi Company</title>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
:root{
  --accent:#ff4458;
  --bg:#ffeef1;
  --white:#ffffff;
  --shadow:rgba(0,0,0,.15);
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body{
  min-height:100vh;
  background:
    url('https://thumbs.dreamstime.com/b/light-opaque-pink-hearts-background-3934735.jpg') center/cover repeat,
    var(--bg);
  overflow:hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== BACKGROUND VIDEO & OVERLAY ===== */
#bg-video{
  position:fixed;
  top:50%; left:50%;
  min-width:100%; min-height:100%;
  width:auto; height:auto;
  transform:translate(-50%,-50%);
  object-fit:cover;
  z-index:-3;
  animation:kenburns 25s ease-in-out infinite alternate;
}
@keyframes kenburns{
  0%{transform:translate(-50%,-50%) scale(1.1);}
  100%{transform:translate(-50%,-50%) scale(1.2);}
}
#video-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  z-index:-2;
  pointer-events:none;
}

/* ===== ANIMATIONS & DECORATION ===== */
.cupid-fly{
  position:absolute;
  top:15%;
  left:-200px;
  width:180px;
  height:180px;
  background:url("https://img.icons8.com/emoji/160/cupid-emoji.png") center/contain no-repeat;
  animation:fly 15s infinite linear;
  z-index:2;
}
@keyframes fly{
  0%{left:-200px; transform: translateY(0);}
  25%{left:10%; transform: translateY(-20px);}
  50%{left:40%; transform: translateY(0);}
  75%{left:10%; transform: translateY(20px);}
  100%{left:-200px; transform: translateY(0);}
}

.cupid-top{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  width:90px;
  height:90px;
  background:url("https://img.icons8.com/emoji/96/cupid-emoji.png") center/contain no-repeat;
  z-index: 10;
}

.heart{
  position:absolute;
  width:28px;
  height:28px;
  background:url("https://img.icons8.com/emoji/48/heart-suit.png") center/contain no-repeat;
  animation:fall 6s linear forwards;
  z-index: 1;
}
@keyframes fall{
  to{
    transform:translate(var(--x),700px) rotate(450deg);
    opacity:0;
  }
}

/* ===== CONTAINER ===== */
#app{
  width:400px;
  max-width:95%;
  height:88vh;
  background:var(--white);
  border-radius:25px;
  box-shadow:0 20px 50px rgba(0,0,0,.3);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  position:relative;
  z-index:5;
  transition: all 0.3s ease;
}

header{
  background:linear-gradient(135deg,#ff4458,#ff7a8a);
  color:white;
  padding:20px;
  text-align:center;
  font-size:1.5rem;
  font-weight:900;
  box-shadow: 0 2px 10px var(--shadow);
}

.section{
  padding:25px;
  display:none;
  flex:1;
  overflow-y:auto;
  animation: slideIn 0.5s ease;
}
.section.active{display:flex; flex-direction:column;}

@keyframes slideIn{
  from{opacity:0; transform: translateX(20px);}
  to{opacity:1; transform: translateX(0);}
}

/* ===== SWIPE INTERFACE ===== */
#swipe-deck {
  position: relative;
  height: 320px;
  width: 100%;
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.swipe-card {
  position: absolute;
  width: 90%;
  background: white;
  border-radius: 20px;
  padding: 15px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  text-align: center;
  transition: transform 0.4s ease, opacity 0.4s ease;
  border: 1px solid #eee;
}

/* ===== CHAT OVERLAY SYSTEM ===== */
#chat-interface {
    position: absolute; inset: 0; background: white; z-index: 20;
    display: none; flex-direction: column; animation: slideUp 0.4s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

#chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #fff9fa; }
.msg { padding: 10px 14px; border-radius: 18px; max-width: 75%; font-size: 0.85rem; }
.msg.me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
.msg.them { align-self: flex-start; background: #eee; color: #333; border-bottom-left-radius: 2px; }

#typing-indicator { font-size: 0.75rem; color: var(--accent); padding: 5px 15px; font-style: italic; display: none; }

#chat-input-area { padding: 12px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; }
#chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; margin:0; }

/* ===== WATERMARK ===== */
.watermark {
    text-align: center;
    padding: 12px;
    font-size: 0.75rem;
    color: #999;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    background: #fdfdfd;
    border-top: 1px solid #eee;
    font-weight: 800;
}

/* ===== TERMS CHECKBOX ===== */
.terms-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
    font-size: 0.85rem;
    color: #555;
}
.terms-container input {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
}

/* ===== FORM ELEMENTS ===== */
label.upload-btn{
  background:var(--accent);
  color:white;
  padding:14px;
  border-radius:35px;
  display:block;
  text-align:center;
  cursor:pointer;
  margin-bottom: 15px;
  font-weight: bold;
}

input, textarea, select{
  width:100%;
  margin-top:12px;
  padding:12px;
  border-radius:15px;
  border:1.5px solid #eee;
  font-size: 1rem;
}

button{
  margin-top:15px;
  padding:14px;
  width:100%;
  border:none;
  border-radius:35px;
  background:var(--accent);
  color:white;
  font-size:1.1rem;
  font-weight: bold;
  cursor:pointer;
}

button:disabled{
  background:#ddd !important;
  color: #aaa;
  cursor: not-allowed;
  box-shadow: none;
}

.option{
  background:#f8f8f8;
  padding:15px;
  border-radius:18px;
  margin:10px 0;
  cursor:pointer;
  border: 2px solid transparent;
}
.option.selected{
  background: #fff0f1;
  border-color: var(--accent);
  color: var(--accent);
  font-weight: bold;
}

/* ===== CIRCULAR FIXES ===== */
#preview{
  width:130px;
  height:130px;
  min-width: 130px;
  min-height: 130px;
  border-radius: 50%;
  margin:0 auto 20px auto;
  background:#fafafa;
  background-size:cover;
  background-position:center;
  border: 4px solid var(--accent);
  display: block;
}

.match-photo-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  margin: 0 auto 10px;
  border: 4px solid #ff4458;
  background-size: cover;
  background-position: center;
}

/* ===== SCORE BADGE ===== */
.score-tag {
    background: #4caf50;
    color: white;
    font-size: 0.7rem;
    padding: 3px 10px;
    border-radius: 10px;
    font-weight: bold;
}

/* ===== STORE BUTTONS ===== */
.store-row {
    display: flex;
    gap: 8px;
    margin-top: 15px;
}
.store-btn {
    flex: 1;
    background: #111;
    color: white;
    padding: 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    cursor: pointer;
}

/* ===== HISTORY STYLING ===== */
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  border-bottom: 2px solid #eee;
  padding-bottom: 5px;
}
.history-title {
  font-size: 1rem;
  font-weight: bold;
  color: #444;
}
.clear-btn {
  font-size: 0.7rem;
  background: #eee;
  color: #666;
  padding: 4px 10px;
  margin: 0;
  width: auto;
  border-radius: 10px;
}
.history-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
  max-height: 200px;
  overflow-y: auto;
}
.history-card {
  display: flex;
  align-items: center;
  gap: 15px;
  background: #f9f9f9;
  padding: 10px;
  border-radius: 15px;
  animation: fadeIn 0.5s ease;
}
.history-img {
  width: 50px;
  height: 50px;
  min-width: 50px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  border: 2px solid var(--accent);
}

#progressWrap{
  height:10px;
  background:#f0f0f0;
  border-radius:20px;
  margin:15px 0;
  overflow: hidden;
}
#progressBar{
  height:100%;
  width:0;
  background:linear-gradient(90deg,#ff4458,#ff7a8a);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<video id="bg-video" autoplay muted loop playsinline>
  <source src="https://cdn.pixabay.com/vimeo/328940281/beach-23230.mp4?width=1280" type="video/mp4">
</video>
<div id="video-overlay"></div>

<div class="cupid-fly"></div>
<div class="cupid-top"></div>
<audio id="matchSound" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3" preload="auto"></audio>

<div id="app">
<header>Mapenzi Yetu üíò</header>

<div id="chat-interface">
    <div style="padding:15px; background:var(--accent); color:white; display:flex; align-items:center; gap:10px;">
      <button onclick="closeChatWindow()" style="background:none; margin:0; padding:5px; width:auto; border:none; color:white; font-size:1.2rem; cursor:pointer;">‚Üê</button>
      <div id="chat-header-img" style="width:35px; height:35px; border-radius:50%; background-size:cover; border:1px solid white;"></div>
      <b id="chat-header-name" style="flex:1">Chat</b>
      <button onclick="reportCurrentMatch()" style="background:none; border:none; color:white; font-size:0.7rem; opacity:0.8; cursor:pointer;">üö© REPORT</button>
    </div>
    <div id="chat-messages"></div>
    <div id="typing-indicator">Soulmate is typing...</div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Write something sweet...">
      <button id="send-chat-btn" style="margin:0; width:auto; border-radius:50%; padding:10px 14px;">üöÄ</button>
    </div>
</div>

<div id="login" class="section active">
  <input type="email" id="email" placeholder="Enter Email">
  <input type="password" id="password" placeholder="Enter Password">
  
  <div class="terms-container">
    <input type="checkbox" id="termsCheck">
    <span>I agree to <b>Tugi Company</b> Terms & Privacy</span>
  </div>

  <button id="signupBtn" disabled>Create Account üíñ</button>
  <button id="loginBtn" style="background:#444" disabled>Log In üíò</button>
</div>

<div id="setup" class="section">
  <div id="preview"></div>
  <label class="upload-btn">
    üì∑ Choose Selfie
    <input type="file" id="photo" accept="image/*" hidden>
  </label>
  
  <select id="userGender">
    <option value="" disabled selected>I am a...</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>

  <select id="targetGender">
    <option value="" disabled selected>Looking for a...</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
    <option value="both">Both</option>
  </select>

  <input type="number" id="age" placeholder="Age (Must be 18+)">
  <textarea id="bio" placeholder="Bio: What makes you happy? ‚ù§Ô∏è"></textarea>
  <button id="start">Start Quiz ‚ù§Ô∏è</button>
</div>

<div id="questions" class="section">
  <div id="counter" style="text-align:right; font-size:0.8rem; color:#888;"></div>
  <div id="progressWrap"><div id="progressBar"></div></div>
  <p style="text-align:center; color:var(--accent); font-size:0.75rem; font-weight:bold; margin-bottom:5px;">CHOOSE MAX 2 ANSWERS</p>
  <h3 id="qtext"></h3>
  <div id="opts"></div>
  <div style="display:flex; gap:10px;">
    <button id="back" style="background:#888">Back</button>
    <button id="next" disabled>Next ‚ù§Ô∏è</button>
  </div>
</div>

<div id="waiting" class="section">
  <div id="matchArea">
     <h3 style="text-align:center; margin-top:20px;">Discovery Mode üíï</h3>
     <div id="swipe-deck"></div>
  </div>
  
  <div class="history-header">
    <span class="history-title">Previous Matches üìú</span>
    <button id="clearHistory" class="clear-btn">Clear All</button>
  </div>
  <div id="historyList" class="history-list"></div>
  
  <div class="store-row">
      <div class="store-btn" onclick="alert('Coming to Play Store!')"><img src="https://img.icons8.com/color/18/000000/google-play.png"/> Play Store</div>
      <div class="store-btn" onclick="alert('Coming to App Store!')"><img src="https://img.icons8.com/ios-filled/18/ffffff/apple-logo.png"/> App Store</div>
  </div>

  <button onclick="location.reload()" style="background:#444; margin-top:20px;">Find Someone New üîÑ</button>
</div>

<div class="watermark">A PRODUCT OF TUGI COMPANY</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, push, remove, onChildAdded, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// EMAILJS SDK INITIALIZATION
(function(){ emailjs.init("LYeFaR5tObePd4GMd"); })();

const firebaseConfig = {
  apiKey: "AIzaSyDr8kx-f8yOSMNzYCXDsnmjWAa3_pWqek4",
  authDomain: "mapenziyetu-61fa8.firebaseapp.com",
  // FIXED REGION TO ASIA
  databaseURL: "https://mapenziyetu-61fa8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mapenziyetu-61fa8",
  storageBucket: "mapenziyetu-61fa8.appspot.com",
  messagingSenderId: "291837171820",
  appId: "1:291837171820:web:77cd8bb29eac82651ba049"
};

// CLOUDINARY CONFIG - FIXED URL AND PRESET
const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dik4lhwxh/image/upload';
const CLOUDINARY_PRESET = 'tugi_presets';

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const sound = document.getElementById("matchSound");

const loginSection = document.getElementById("login");
const setupSection = document.getElementById("setup");
const questionsSection = document.getElementById("questions");
const waitingSection = document.getElementById("waiting");
const nextBtn = document.getElementById("next");
const backBtn = document.getElementById("back");
const previewDiv = document.getElementById("preview");
const photoInput = document.getElementById("photo");
const termsCheck = document.getElementById("termsCheck");
const signupBtn = document.getElementById("signupBtn");
const loginBtn = document.getElementById("loginBtn");
const clearHistoryBtn = document.getElementById("clearHistory");

termsCheck.onchange = () => {
  signupBtn.disabled = !termsCheck.checked;
  loginBtn.disabled = !termsCheck.checked;
};

const qs=[
  {q:"What describes you best?",options:["Romantic üíï","Adventurous üåç","Calm üåä","Funny üòÇ"]},
  {q:"Ideal date?",options:["Movies üé¨","Walk üö∂","Dinner üçΩ","Gaming üéÆ"]},
  {q:"What do you value most?",options:["Trust ü§ù","Love ‚ù§Ô∏è","Money üí∞","Peace ‚òÆÔ∏è"]},
  {q:"Perfect weekend?",options:["Home üè†","Travel ‚úàÔ∏è","Party üéâ","Family üë®‚Äçüë©‚Äçüëß"]},
  {q:"Morning or night?",options:["Morning ‚òÄÔ∏è","Night üåô","Both ‚ú®","Neither üò¥"]},
  {q:"Reply speed?",options:["Fast ‚ö°","Soon ‚è≥","Depends ü§∑","Rarely üòÖ"]},
  {q:"Love language?",options:["Words üí¨","Time ‚è∞","Gifts üéÅ","Touch ü§ç"]},
  {q:"Turn-on?",options:["Confidence üòé","Kindness ü•∞","Humor üòÇ","Looks üî•"]},
  {q:"Turn-off?",options:["Rudeness ‚ùå","Dishonesty üò∂","Laziness üò¥","Arrogance üôÑ"]},
  {q:"Jealous?",options:["Very üò¨","A bit üôÇ","No üòå","Depends ü§î"]},
  {q:"Relationship type?",options:["Serious üíç","Casual üòå","Open üí¨","Unsure ü§ç"]},
  {q:"Long distance?",options:["Yes ‚ù§Ô∏è","No ‚ùå","Maybe ü§∑","Depends üìç"]},
  {q:"Communication?",options:["Direct üí¨","Soft ü´∂","Silent ü§ê","Expressive üé≠"]},
  {q:"Hangout?",options:["Home üè†","Beach üèñ","Cafe ‚òï","Club üé∂"]},
  {q:"Believe soulmates?",options:["Yes üíû","No üôÖ","Maybe ü§î","Unsure ü§∑"]},
  {q:"Ideal partner?",options:["Loyal üîê","Funny üòÇ","Supportive ü§ç","Ambitious üöÄ"]},
  {q:"When hurt?",options:["Talk üí¨","Withdraw üòî","Forgive ‚ù§Ô∏è","Ignore üò∂"]},
  {q:"Show love?",options:["Actions ü§ù","Words üíñ","Time ‚è≥","Gifts üéÅ"]},
  {q:"Commitment?",options:["Ready üíç","Soon ‚è∞","Not yet üòå","Unsure ü§∑"]},
  {q:"Dating goal?",options:["Marriage üíí","Relationship ‚ù§Ô∏è","Fun üòÑ","Friends ü§ù"]}
];

let i=0, answers=[], photoFile=null, currentRoomID = null, currentTargetId = null;

signupBtn.onclick = () => {
  createUserWithEmailAndPassword(auth, email.value, password.value)
    .then(() => { loginSection.classList.remove("active"); setupSection.classList.add("active"); })
    .catch(err => alert(err.message));
};

loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .then(() => { loginSection.classList.remove("active"); setupSection.classList.add("active"); })
    .catch(err => alert(err.message));
};

photoInput.onchange = e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => { previewDiv.style.backgroundImage=`url(${reader.result})`; previewDiv.style.border="4px solid var(--accent)"; };
    reader.readAsDataURL(file);
    photoFile = file;
  }
};

start.onclick = async () => {
  if(age.value < 18 || !userGender.value || !targetGender.value){
    alert("Please complete all fields (Must be 18+).");
    return;
  }
  sound.play().then(() => { sound.pause(); sound.currentTime = 0; }).catch(() => {});
  setupSection.classList.remove("active");
  questionsSection.classList.add("active");
  load();
};

function load(){
  nextBtn.disabled = true;
  const q = qs[i];
  qtext.textContent = q.q;
  counter.textContent = `Question ${i+1} of ${qs.length}`;
  progressBar.style.width = ((i+1)/qs.length*100) + "%";
  opts.innerHTML = "";
  
  if(!answers[i]) answers[i] = [];

  q.options.forEach(opt => {
    const div = document.createElement("div");
    div.className = "option";
    if(answers[i].includes(opt)){ div.classList.add("selected"); nextBtn.disabled = false; }
    div.textContent = opt;
    div.onclick = () => {
      if(answers[i].includes(opt)){
          answers[i] = answers[i].filter(a => a !== opt);
          div.classList.remove("selected");
      } else {
          if(answers[i].length < 2) {
              answers[i].push(opt);
              div.classList.add("selected");
          } else {
              alert("Max 2 answers allowed! üíñ");
          }
      }
      nextBtn.disabled = answers[i].length === 0;
    };
    opts.appendChild(div);
  });
}

next.onclick = async () => {
  if(i < qs.length - 1){ i++; load(); }
  else {
    questionsSection.classList.remove("active");
    waitingSection.classList.add("active");
    
    // CLOUDINARY UPLOAD LOGIC
    let photoURL = "https://img.icons8.com/emoji/96/person-emoji.png";
    if(photoFile){
      try {
        const formData = new FormData();
        formData.append('file', photoFile);
        formData.append('upload_preset', CLOUDINARY_PRESET);

        const response = await fetch(CLOUDINARY_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('Upload failed');
        const data = await response.json();
        photoURL = data.secure_url;
      } catch (err) {
        console.error("Photo upload error:", err);
      }
    }

    const userData = { age: age.value, bio: bio.value, gender: userGender.value, preference: targetGender.value, photo: photoURL, answers: answers, uid: auth.currentUser.uid, email: auth.currentUser.email };
    await set(ref(db, "users/" + auth.currentUser.uid), userData);
    showSwipeDeck(userData);
    loadHistory();
  }
};

backBtn.onclick = () => { if(i > 0){ i--; load(); } };

// CHAT FUNCTIONS
function openMatchChat(target) {
    currentTargetId = target.uid;
    const chatInt = document.getElementById("chat-interface");
    const msgBox = document.getElementById("chat-messages");
    chatInt.style.display = "flex";
    document.getElementById("chat-header-name").innerText = "Match (Age " + target.age + ")";
    document.getElementById("chat-header-img").style.backgroundImage = `url(${target.photo})`;
    msgBox.innerHTML = "";
    currentRoomID = auth.currentUser.uid < target.uid ? auth.currentUser.uid + "_" + target.uid : target.uid + "_" + auth.currentUser.uid;
    
    onChildAdded(ref(db, `chats/${currentRoomID}/messages`), (snap) => {
        const val = snap.val();
        const d = document.createElement("div");
        d.className = "msg " + (val.sender === auth.currentUser.uid ? "me" : "them");
        d.innerText = val.text;
        msgBox.appendChild(d);
        msgBox.scrollTop = msgBox.scrollHeight;
    });

    onValue(ref(db, `chats/${currentRoomID}/typing/${target.uid}`), (snap) => {
      document.getElementById("typing-indicator").style.display = snap.val() ? "block" : "none";
    });

    document.getElementById("chat-input").oninput = (e) => {
      const isTyping = e.target.value.length > 0;
      update(ref(db, `chats/${currentRoomID}/typing`), { [auth.currentUser.uid]: isTyping });
    };

    document.getElementById("send-chat-btn").onclick = () => {
        const input = document.getElementById("chat-input");
        if(!input.value) return;
        push(ref(db, `chats/${currentRoomID}/messages`), { sender: auth.currentUser.uid, text: input.value, time: Date.now() });
        input.value = "";
        update(ref(db, `chats/${currentRoomID}/typing`), { [auth.currentUser.uid]: false });
    };
}

window.closeChatWindow = () => { document.getElementById("chat-interface").style.display = "none"; };

// SWIPE & MATCH LOGIC
async function showSwipeDeck(me) {
  const snapshot = await get(ref(db, "users"));
  const users = snapshot.val();
  const deck = document.getElementById("swipe-deck");
  deck.innerHTML = "";
  
  for(let uid in users){
    if(uid === auth.currentUser.uid) continue;
    const u = users[uid];
    const genderMatch = (me.preference === 'both' || me.preference === u.gender) && (u.preference === 'both' || u.preference === me.gender);
    
    if(genderMatch){
      let count = 0;
      for(let k=0; k<qs.length; k++){
        const overlap = me.answers[k].filter(val => u.answers[k].includes(val));
        if(overlap.length > 0) count++;
      }
      let percent = (count / qs.length) * 100;
      
      // Match found logic
      if(percent >=  0) {
          const namePart = me.email.split('@')[0];
          sound.play().catch(()=>{});

          emailjs.send('service_1lxkg3u', 'template_i956ifo', {
            to_email: me.email,
            to_name: namePart,
            match_name: "Match Found! (Age " + u.age + ")",
            link: window.location.href
          });

          document.getElementById("app").innerHTML = `
            <div style="padding:40px; text-align:center;">
              <h1 style="font-size:4rem; margin-bottom:10px;">üèÉ‚Äç‚ôÇÔ∏èüí®</h1>
              <h2 style="color:var(--accent); font-weight:900;">GO AWAY FAST!</h2>
              <p style="margin:20px 0; font-size:1.1rem;">Hey <b>${namePart}</b>, we found your soulmate!</p>
              <p style="color:#666; font-size:0.9rem;">We sent a notification to your Gmail. Session closing for privacy.</p>
              <div style="margin-top:30px; font-weight:bold; color:var(--accent);">Redirecting in 6 seconds...</div>
            </div>
          `;
          
          setTimeout(() => { window.location.href = "https://www.google.com"; }, 6000);
          return;
      }
    }
  }
  deck.innerHTML = "<p style='text-align:center; color:#888;'>Scanning... No high scores yet. Stay online!</p>";
}

window.likeMatch = async (uid) => {
  const snapshot = await get(ref(db, `users/${uid}`));
  const match = snapshot.val();
  sound.play().catch(() => {});
  push(ref(db, `history/${auth.currentUser.uid}`), { age: match.age, photo: match.photo, bio: match.bio, score: '70+' });
  openMatchChat(match);
};

// REPORT & BLOCK
window.reportUser = (uid) => {
  if(confirm("Report and block this user?")){
    push(ref(db, `reports`), { reportedBy: auth.currentUser.uid, reportedUser: uid, timestamp: Date.now() });
    alert("User reported.");
    location.reload();
  }
};

window.reportCurrentMatch = () => reportUser(currentTargetId);

async function loadHistory() {
  const historyList = document.getElementById("historyList");
  const snapshot = await get(ref(db, `history/${auth.currentUser.uid}`));
  historyList.innerHTML = "";
  if(snapshot.exists()) {
      const data = snapshot.val();
      Object.values(data).reverse().forEach(match => {
          const card = document.createElement("div");
          card.className = "history-card";
          card.innerHTML = `<div class="history-img" style="background-image:url(${match.photo})"></div><div><div style="font-weight:bold;">Age ${match.age}</div><div style="font-size:0.75rem; color:#888;">"${match.bio.substring(0,25)}..."</div></div>`;
          historyList.appendChild(card);
      });
  } else { historyList.innerHTML = "<p style='font-size:0.8rem; color:#bbb; text-align:center;'>No history.</p>"; }
}

clearHistoryBtn.onclick = async () => {
  if(confirm("Clear history?")) { await remove(ref(db, `history/${auth.currentUser.uid}`)); loadHistory(); }
};

setInterval(()=>{
  const h=document.createElement("div"); h.className="heart"; document.body.appendChild(h);
  h.style.left=(Math.random()*100)+"vw"; h.style.setProperty("--x",(Math.random()*200-100)+"px");
  setTimeout(()=>h.remove(),6000);
},600);
</script>
</body>
</html>

